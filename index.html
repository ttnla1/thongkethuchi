<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thá»‘ng KÃª Thu Chi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<div class="max-w-5xl mx-auto p-6">

  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-indigo-900">Thá»‘ng KÃª Thu Chi</h1>
    <p class="text-indigo-600">Tá»± Ä‘á»™ng lÆ°u & ghi nhá»› dá»¯ liá»‡u</p>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <form id="dataForm" class="space-y-5">

      <div>
        <label class="font-semibold">ğŸ“… NgÃ y</label>
        <input type="date" id="date" class="w-full border rounded-lg p-2" required>
      </div>

      <div class="bg-yellow-50 p-4 rounded-lg border">
        <h3 class="font-bold mb-2">ğŸ“¦ Tá»“n hÃ´m qua</h3>
        <div class="grid grid-cols-2 gap-3">
          <input id="tonKg" type="number" step="0.01" placeholder="Kg" class="border p-2 rounded">
          <input id="tonGia" type="number" placeholder="ÄÆ¡n giÃ¡" class="border p-2 rounded">
        </div>
        <p class="mt-2 font-semibold">ThÃ nh tiá»n: <span id="tonTien">0 â‚«</span></p>
      </div>

      <div class="bg-green-50 p-4 rounded-lg border">
        <h3 class="font-bold mb-2">ğŸ“¥ Nháº­p má»›i</h3>
        <div class="grid grid-cols-2 gap-3">
          <input id="nhapKg" type="number" step="0.01" placeholder="Kg" class="border p-2 rounded">
          <input id="nhapGia" type="number" placeholder="ÄÆ¡n giÃ¡" class="border p-2 rounded">
        </div>
        <p class="mt-2 font-semibold">ThÃ nh tiá»n: <span id="nhapTien">0 â‚«</span></p>
      </div>

      <div class="bg-blue-50 p-4 rounded-lg border">
        <h3 class="font-bold mb-2">ğŸ’° BÃ¡n ra</h3>
        <div class="grid grid-cols-2 gap-3">
          <input id="banKg" type="number" step="0.01" placeholder="Kg" class="border p-2 rounded">
          <input id="banGia" type="number" placeholder="ÄÆ¡n giÃ¡" class="border p-2 rounded">
        </div>
        <p class="mt-2 font-semibold">ThÃ nh tiá»n: <span id="banTien">0 â‚«</span></p>
      </div>

      <button class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">
        ğŸ“Š TÃ­nh toÃ¡n & LÆ°u
      </button>
    </form>
  </div>

  <div id="result" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
    <h2 class="text-xl font-bold mb-4">ğŸ“ˆ Káº¿t quáº£</h2>
    <p>ğŸ”¹ Tá»•ng kg: <b id="tongKg"></b></p>
    <p>ğŸ”¹ GiÃ¡ vá»‘n bÃ¬nh quÃ¢n: <b id="giaVon"></b></p>
    <p>ğŸ”¹ Doanh thu: <b id="doanhThu"></b></p>
    <p class="mt-3 text-2xl font-bold" id="laiLo"></p>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-bold mb-4">ğŸ“‹ Lá»‹ch sá»­ (Tá»± Ä‘á»™ng lÆ°u)</h2>
    <div id="history" class="space-y-3 text-sm"></div>
  </div>

</div>

<script>
/* ---------- IndexedDB ---------- */
let db;
let records = [];
const DB_NAME = 'ThuChiDB';
const STORE = 'records';

const $ = id => document.getElementById(id);
const money = v => new Intl.NumberFormat('vi-VN').format(Math.round(v)) + ' â‚«';

function initDB() {
  return new Promise(resolve => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(STORE, { keyPath: 'id' });
    };
    req.onsuccess = e => {
      db = e.target.result;
      loadRecords();
      resolve();
    };
  });
}

function saveRecord(record) {
  const tx = db.transaction(STORE, 'readwrite');
  tx.objectStore(STORE).put(record);
}

function loadRecords() {
  const tx = db.transaction(STORE, 'readonly');
  const req = tx.objectStore(STORE).getAll();
  req.onsuccess = () => {
    records = req.result || [];
    renderHistory();
  };
}

/* ---------- Logic ---------- */
function updateTien() {
  $('tonTien').textContent = money(($('tonKg').value || 0) * ($('tonGia').value || 0));
  $('nhapTien').textContent = money(($('nhapKg').value || 0) * ($('nhapGia').value || 0));
  $('banTien').textContent = money(($('banKg').value || 0) * ($('banGia').value || 0));
}

['tonKg','tonGia','nhapKg','nhapGia','banKg','banGia']
.forEach(id => $(id).addEventListener('input', updateTien));

$('date').valueAsDate = new Date();

$('dataForm').addEventListener('submit', e => {
  e.preventDefault();

  const tonKg = +$('tonKg').value || 0;
  const tonGia = +$('tonGia').value || 0;
  const nhapKg = +$('nhapKg').value || 0;
  const nhapGia = +$('nhapGia').value || 0;
  const banKg = +$('banKg').value || 0;
  const banGia = +$('banGia').value || 0;

  const tongKg = tonKg + nhapKg;
  const giaVon = tongKg ? (tonKg*tonGia + nhapKg*nhapGia) / tongKg : 0;
  const doanhThu = banKg * banGia;
  const laiLo = doanhThu - banKg * giaVon;

  const record = {
    id: Date.now(),
    date: $('date').value,
    laiLo
  };

  records.push(record);
  saveRecord(record);

  $('result').classList.remove('hidden');
  $('tongKg').textContent = tongKg.toFixed(2) + ' kg';
  $('giaVon').textContent = money(giaVon) + '/kg';
  $('doanhThu').textContent = money(doanhThu);
  $('laiLo').textContent = (laiLo >= 0 ? 'âœ… LÃ£i ' : 'âŒ Lá»— ') + money(Math.abs(laiLo));
  $('laiLo').className = laiLo >= 0 ? 'text-green-600 text-2xl font-bold' : 'text-red-600 text-2xl font-bold';

  renderHistory();
});

function renderHistory() {
  $('history').innerHTML = records
    .sort((a,b)=>b.id-a.id)
    .map(r => `
      <div class="border p-3 rounded flex justify-between">
        <span>ğŸ“… ${r.date}</span>
        <span class="${r.laiLo>=0?'text-green-600':'text-red-600'} font-bold">
          ${money(Math.abs(r.laiLo))}
        </span>
      </div>
    `).join('');
}

window.onload = initDB;
</script>

</body>
</html>
